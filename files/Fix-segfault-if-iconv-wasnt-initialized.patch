From 6ff3282d001436b606510894bf8c2c05776bd7f8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benoit=20Gr=C3=A9goire?= <benoitg@coeus.ca>
Date: Fri, 26 Jul 2019 14:26:36 -0400
Subject: [PATCH] Fix segfault if iconv wasn't initialised (in the case of a
 malformed file).  Fixes #24

---
 lib/ofx_preproc.cpp | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/lib/ofx_preproc.cpp b/lib/ofx_preproc.cpp
index d56ced0..932b909 100644
--- a/lib/ofx_preproc.cpp
+++ b/lib/ofx_preproc.cpp
@@ -84,7 +84,7 @@ int ofx_proc_file(LibofxContextPtr ctx, const char * p_filename)
   bool ofx_start = false;
   bool ofx_end = false;
   bool file_is_xml = false;
-
+  bool used_iconv = false;
   ifstream input_file;
   ofstream tmp_file;
   char *filenames[3];
@@ -259,6 +259,7 @@ int ofx_proc_file(LibofxContextPtr ctx, const char * p_filename)
                 tocode = LIBOFX_DEFAULT_OUTPUT_ENCODING;
                 message_out(DEBUG, "ofx_proc_file(): Setting up iconv for fromcode: " + fromcode + ", tocode: " + tocode);
                 conversion_descriptor = iconv_open (tocode.c_str(), fromcode.c_str());
+                used_iconv = true;
 #endif
             }
           }
@@ -350,7 +351,7 @@ int ofx_proc_file(LibofxContextPtr ctx, const char * p_filename)
     input_file.close();
     tmp_file.close();
 #ifdef HAVE_ICONV
-    if (file_is_xml == false)
+    if (used_iconv == true)
     {
       iconv_close(conversion_descriptor);
     }
